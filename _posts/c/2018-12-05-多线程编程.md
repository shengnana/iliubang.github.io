---
layout: post
title: 多线程编程
author: 刘邦
excerpt: "POSIX threads tutorial"
catalog: true
tags: [c]
category: c
comments: true
---

## 简介

代码通常是以序列化（顺序）的方式编写的。序列化这个术语是什么意思？在不考虑多核处理器和忽略指令级并行性(ILP)的情况下，
代码是按照顺序的，一个接着一个的方式执行的。通常情况下，程序的一些潜在部分可以通过使用多线程来提高性能。

随着具有对称多处理的机器的日益普及（主要是由于多核处理器的兴起），使得多线程编程变得非常有实用价值。

为什么大多数程序都是顺序执行的？有人猜测这可能是因为没有人能以一种比较容易遵循的方式来教我们如何进行编程。更糟糕的是，
对一些重要的代码进行多线程编程是有很大难度的，不仅需要我们仔细分析问题的能力，更需要有好的程序设计。

首先我们将深入到线程的世界中，我们将研究线程同步原语，然后介绍如何使用POSIX pthreads来进行多线程编程。

## 什么是线程？

### 打个比方

这不是跟缝纫机缝纫是一回事吗？

是的。

那么怎么将它跟编程对应起来呢？

把缝纫机针比作处理器，线程比作线，如果你有两个针一根线，你完成工作所需要的时间就要比用两根针两根线所需要的时间多（因为有一根针是空闲的）。以此类推，如果一根针需要缝一颗扣子（阻塞式IO），那么另一根针就可以继续做其他有用的事情，即使另一根针在
一颗扣子上花了一小时。但是如果你只用一根针，你将会落后将近一个小时。

### 定义

为了正式地定义线程，我们必须首先理解线程操作的边界在哪里。

系统程序在从磁盘载入到计算机的记忆体中，变成可执行体时，就可以产生一个进程。一个进程可以被一个或多个处理器执行。进程在记忆体中包含了记录当前程序执行位置的程序计数器(PC)，寄存器，变量，文件处理器，信号等等一些重要信息。

线程是程序中独立运行的指令集合。

上图向我们清晰的展示了多个线程共享同一个进程的地址空间，也就说用来描述进程的记忆体中的很多信息都可以在线程之间共享。但是线程中也有他自己的信息，例如栈，寄存器和一些线程特有的数据信息。这些信息足够一个线程在不依赖主线程中其他线程的情况下独立运行。

### 多线程编程设计模式

**Thread Pool模式（线程池）**

**Pipline（流水线）**

## 保护共享资源

多个线程可能会操作不同的数据，但是通常也会操作同一个数据。没有一种能定义线程安全访问协议的机制而允许线程访问共享数据是很危险的。当一个线程正在访问共享数据的时候，其他想要访问该数据的线程就必须阻塞。

### 互斥

互斥是一种线性访问资源的方式。它是指在某一个时刻只允许一个线程修改共享资源。

### 互斥锁的类型

- 递归锁
- 读写锁

### 原子操作
