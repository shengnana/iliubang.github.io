<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[åˆ˜é‚¦çš„åšå®¢]]></title>
  <link href="http://iliubang.github.io/atom.xml" rel="self"/>
  <link href="http://iliubang.github.io/"/>
  <updated>2016-12-04T17:44:07+08:00</updated>
  <id>http://iliubang.github.io/</id>
  <author>
    <name><![CDATA[]]></name>
    
  </author>
  <generator uri="http://www.mweb.im/">MWeb</generator>
  
  <entry>
    <title type="html"><![CDATA[Elasticsearch é›†ç¾¤æ­å»º]]></title>
    <link href="http://iliubang.github.io/14808396945913.html"/>
    <updated>2016-12-04T16:21:34+08:00</updated>
    <id>http://iliubang.github.io/14808396945913.html</id>
    <content type="html"><![CDATA[
<h2 id="toc_0">1. æœåŠ¡å™¨èŠ‚ç‚¹å’Œæ‰€éœ€è½¯ä»¶å‡†å¤‡</h2>

<p><strong>æœåŠ¡å™¨</strong></p>

<ul>
<li>vm-911(debian8, 192.168.9.11)</li>
<li>vm-912(debian8, 192.168.9.12)</li>
<li>vm-913(debian8, 192.168.9.13)</li>
</ul>

<p><strong>è½¯ä»¶</strong></p>

<ul>
<li><a href="http://download.oracle.com/otn-pub/java/jdk/8u112-b15/jdk-8u112-linux-x64.tar.gz">jdk-8u112-linux-x64.tar.gz</a></li>
<li><a href="https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/tar/elasticsearch/2.4.2/elasticsearch-2.4.2.tar.gz">elasticsearch-2.4.2.tar.gz</a></li>
<li><a href="https://download.elastic.co/kibana/kibana/kibana-4.6.1-linux-x86_64.tar.gz">kibana-4.6.1</a></li>
</ul>

<h2 id="toc_1">2.å¼€å§‹å®‰è£…</h2>

<p><strong>æ³¨æ„ï¼š</strong> å®‰è£…å‰è¯·ç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿæ”¯æŒhttpsï¼Œå¦‚æœä¸æ”¯æŒï¼Œéœ€è¦è¿›è¡Œä¸€ä¸‹æ“ä½œ</p>

<pre><code class="language-bash">sudo apt-get update
sudo apt-get install apt-transport-https ca-certificates
</code></pre>

<p>(1). é…ç½®jdk</p>

<p>é¦–å…ˆè¦åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šé…ç½®å¥½jdkçš„ç¯å¢ƒï¼Œå„ä¸ªèŠ‚ç‚¹é…ç½®æ–¹æ³•ç›¸åŒ</p>

<pre><code class="language-bash">#è¿›å…¥è½¯ä»¶å®‰è£…ç›®å½•s
cd /opt/app
#ä¸‹è½½jdk
sudo curl -L &quot;http://download.oracle.com/otn-pub/java/jdk/8u112-b15/jdk-8u112-linux-x64.tar.gz&quot; -H &quot;Cookie: oraclelicense=accept-securebackup-cookie&quot;  -H &quot;Connection: keep-alive&quot; -O  
#è§£å‹
sudo tar -zxvf jdk-8u112-linux-x64.tar.gz
sudo mv jdk-8u112 java
#æ·»åŠ ç¯å¢ƒå˜é‡
sudo echo &#39;export JAVA_HOME=/opt/app/java&#39; &gt;&gt; /etc/bashrc
sudo echo &#39;export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar&#39; &gt;&gt; /etc/bashrc
sudo echo &#39;export PATH=$JAVA_HOME/bin:$GOPATH/bin:$PATH&#39; &gt;&gt; /etc/bashrc
source ~/.bashrc
</code></pre>

<p><strong>æ³¨æ„</strong><br/>
1. è®¾ç½®ç¯å¢ƒå˜é‡çš„æ—¶å€™ä½¿ç”¨<code>/etc/bashrc</code>æ–‡ä»¶ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨<code>~/.bashrc</code>ï¼Œæ˜¯å› ä¸ºåæœŸå¾ˆå¤šæ“ä½œéœ€è¦ä½¿ç”¨<code>sudo</code>ï¼Œå¦‚æœæ”¾åœ¨ç§æœ‰é…ç½®æ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆè¿˜éœ€è¦ç»™rootç”¨æˆ·ä¹Ÿé…ç½®ä¸€å¥—ç¯å¢ƒå˜é‡ï¼Œæ‰€ä»¥ä¸ºäº†é¿å…é‡å¤ï¼Œä½¿ç”¨äº†å…¨å±€é…ç½®.<br/>
2. åœ¨ç”¨æˆ·<code>~/.bashrc</code>æ–‡ä»¶ä¸­åŠ å…¥ä»¥ä¸‹ä»£ç </p>

<pre><code class="language-bash">if [ -f /etc/bashrc ] ; then
   . /etc/bashrc
fi
</code></pre>

<p>(2). ä¸‹è½½å¹¶å®‰è£…elasticsearch</p>

<pre><code class="language-bash">cd /opt/app
sudo wget https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/tar/elasticsearch/2.4.2/elasticsearch-2.4.2.tar.gz
sudo tar -zxvf elasticsearch-2.4.2.tar.gz
# å®‰è£…Marvel Agent
cd elasticsearch-2.4.2
sudo bin/plugin install license
sudo bin/plugin install marvel-agent
</code></pre>

<p>(3). ä¸‹è½½å¹¶å®‰è£…kibana</p>

<pre><code class="language-bash">cd /opt/app
sudo wget https://download.elastic.co/kibana/kibana/kibana-4.6.1-linux-x86_64.tar.gz
sudo tar -zxvf kibana-4.6.1-linux-x86_64.tar.gz
#å®‰è£…marvelæ’ä»¶
cd kibana-4.6.1
bin/kibana plugin --install elasticsearch/marvel
#å®‰è£…senseæ’ä»¶
bin/kibana plugin --install elastic/sense
</code></pre>

<h2 id="toc_2">3. é…ç½®å¹¶è¿è¡Œ</h2>

<p>é¦–å…ˆå¯¹elasticsearchè¿›è¡Œé…ç½®ï¼Œè¿™é‡Œåªæ‹¿vm-911è¿™ä¸ªèŠ‚ç‚¹è¯´æ˜ï¼Œå…¶ä»–èŠ‚ç‚¹ç±»ä¼¼</p>

<pre><code class="language-bash">cd /opt/app/elasticsearch-2.4.2/config/
sudo vim elasticsearch.yml
# ä¿®æ”¹ä¸€ä¸‹é…ç½®é¡¹
cluster.name: linger #é›†ç¾¤åï¼Œä¸‰ä¸ªèŠ‚ç‚¹ä½¿ç”¨åŒä¸€ä¸ªé›†ç¾¤å
node.name: vm-911 #èŠ‚ç‚¹å
path.data: /data/elasticsearch #æ•°æ®å­˜å‚¨ç›®å½•
path.logs: /data/logs/elasticsearch #æ—¥å¿—å­˜å‚¨ç›®å½•
bootstrap.memory_lock: false #å¯åŠ¨æ—¶æ˜¯å¦é”å®šå†…å­˜
network.host: 192.168.9.11 #ç»‘å®šip,å…¶ä»–èŠ‚ç‚¹æ ¹æ®å®é™…æƒ…å†µæŒ‡å®š
http.port: 9200 #ç«¯å£
discovery.zen.ping.unicast.hosts: [&quot;vm-911&quot;, &quot;vm-912&quot;, &quot;vm-913&quot;] #å•æ’­é…ç½®,èŠ‚ç‚¹å‘æŒ‡å®šä¸»æœºå‘é€å•æ’­è¯·æ±‚
</code></pre>

<p>é…ç½®kibana</p>

<pre><code class="language-bash">cd /opt/app/kibana-4.6.1/config
sudo vim kibana.yml 
server.port: 5601 #webæœåŠ¡ç«¯å£
server.host: &quot;0.0.0.0&quot;#webæœåŠ¡host
elasticsearch.url: &quot;http://192.168.9.11:9200&quot; #esæœåŠ¡çš„http url
</code></pre>

<h2 id="toc_3">å¯åŠ¨æœåŠ¡</h2>

<p>å¯åŠ¨elasticsearch</p>

<pre><code class="language-bash"># vm-911
cd /opt/app/elasticsearch-2.4.2/
sudo ./bin/elasticsearch -d # -dè¡¨ç¤ºä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œ
cd /opt/app/kibana-4.6.1/
sudo ./bin/kibana
# åˆ†åˆ«åœ¨vm-912, vm-913ä¸Šå¯åŠ¨elasticsearch ......
</code></pre>

<p>Open your browser and enter <a href="http://192.168.9.11:5601">http://192.168.9.11:5601</a> </p>

<p><img src="media/14808396945913/14808445404189.jpg" alt=""/></p>

<p><img src="media/14808396945913/14808445823838.jpg" alt=""/></p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Javaä¸­çš„æ„é€ ä»£ç å—å’Œé™æ€ä»£ç å—]]></title>
    <link href="http://iliubang.github.io/14803466591982.html"/>
    <updated>2016-11-28T23:24:19+08:00</updated>
    <id>http://iliubang.github.io/14803466591982.html</id>
    <content type="html"><![CDATA[
<h2 id="toc_0">æ„é€ ä»£ç å—</h2>

<p>æ„é€ ä»£ç å—ï¼Œå°±æ˜¯ç±»å½“ä¸­ç›´æ¥åŒ…å«çš„ä¸å¸¦ä»»ä½•ä¿®é¥°çš„ä»£ç å—ã€‚ä¾‹å¦‚ï¼š</p>

<pre><code class="language-java">class Foo {
    private String name;
    {
        System.out.println(&quot;æˆ‘æ˜¯æ„é€ ä»£ç å—&quot;);
    }
    Foo() {
        System.out.println(&quot;æ— å‚æ„é€ æ–¹æ³•&quot;);
    }
    Foo(String name) {
        System.out.println(&quot;æœ‰å‚æ„é€ æ–¹æ³•&quot;);
    }
}

public class Bar {
    public static void main(String[] args) {
        Foo f1 = new Foo();
        Foo f2 = new Foo(&quot;liubang&quot;);
    }
}
</code></pre>

<p>ç¼–è¯‘æ‰§è¡Œåçš„ç»“æœä¸ºï¼š</p>

<pre><code>liubang@venux:~ $ java Bar
æˆ‘æ˜¯æ„é€ ä»£ç å—
æ— å‚æ„é€ æ–¹æ³•
æˆ‘æ˜¯æ„é€ ä»£ç å—
æœ‰å‚æ„é€ æ–¹æ³•
</code></pre>

<p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ— è®ºä½¿ç”¨å“ªä¸ªæ„é€ æ–¹æ³•ï¼Œéƒ½ä¼šå…ˆæ‰§è¡Œæ„é€ ä»£ç å—ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºä»¥ä¸‹ç‰¹ç‚¹ï¼š<br/>
1. æ„é€ ä»£ç å—æ˜¯è¢«ç±»ä½“ç›´æ¥åŒ…å«çš„ï¼›<br/>
2. æ„é€ ä»£ç å—æ˜¯éšç€ç±»çš„å®ä¾‹åŒ–è€Œæ‰§è¡Œï¼›<br/>
3. æ„é€ ä»£ç å—å¯ä»¥ç»™æ‰€æœ‰å¯¹è±¡åˆå§‹åŒ–ï¼›<br/>
4. æ„é€ ä»£ç å—å…ˆäºæ„é€ æ–¹æ³•æ‰§è¡Œï¼›</p>

<h2 id="toc_1">é™æ€ä»£ç å—</h2>

<p>é™æ€ä»£ç å—å°±æ˜¯è¢«staticä¿®é¥°çš„ä»£ç å—ã€‚ä¾‹å¦‚ï¼š</p>

<pre><code class="language-java">class Foo {
    static {
        System.out.println(&quot;A&quot;);
    }
    Foo() {
        System.out.println(&quot;construct run&quot;);
    }
    static {
        System.out.println(&quot;B&quot;);
    }
    
    public static void say() {
        System.out.println(&quot;say run&quot;);
    }
}

public class Bar {
    static {
        System.out.println(&quot;C&quot;);
    }
    public static void main(String[] args) {
        Foo.say();
        Foo f1 = new Foo();
        System.out.println(&quot;main run&quot;);
    } 
    static {
        System.out.println(&quot;D&quot;);
    }
}
</code></pre>

<p>ç¼–è¯‘è¿è¡Œçš„ç»“æœä¸ºï¼š</p>

<pre><code>liubang@venux:~ $ java Bar
C
D
A
B
say run
construct run
main run
</code></pre>

<p>ä»ä¸Šé¢çš„ç»“æœä¸­æˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œé™æ€ä»£ç å—å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š<br/>
1. åœ¨ç±»è¢«åŠ è½½çš„æ—¶å€™æ‰§è¡Œï¼Œä¸”åªæ‰§è¡Œä¸€æ¬¡ï¼›<br/>
2. åœ¨åŒä¸€ä¸ªç±»ä¸­æŒ‰ç…§å…ˆåé¡ºåºä¾æ¬¡æ‰§è¡Œï¼›<br/>
3. åœ¨ä¸åŒç±»ä¹‹é—´ï¼ŒæŒ‰ç…§ç±»è¢«åŠ è½½çš„é¡ºåºå…ˆåæ‰§è¡Œï¼›</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[åŸºäºCè¯­è¨€çš„ç¼–ç¨‹è¯­è¨€å¼€å‘ -- yacc/lexåˆæ­¥]]></title>
    <link href="http://iliubang.github.io/14775733948936.html"/>
    <updated>2016-10-27T21:03:14+08:00</updated>
    <id>http://iliubang.github.io/14775733948936.html</id>
    <content type="html"><![CDATA[
<h2 id="toc_0">Preface</h2>

<p>å½“ä»Šä¸–é“ï¼Œå„ç§é«˜çº§è¯­è¨€ç™¾èŠ±é½æ”¾ã€‚ç„¶è€Œä¼šæœ‰äººå‘å‡ºè¿™æ ·çš„ç–‘é—®--è®¡ç®—æœºçœŸçš„èƒ½å¤Ÿè¯†åˆ«è¿™ä¹ˆå¤šè¯­è¨€å—ï¼Ÿç¨å¾®æœ‰ç‚¹å¸¸è¯†çš„äººéƒ½çŸ¥é“ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸å¯èƒ½æ»´ï¼åœ¨è®¡ç®—æœºçš„ä¸–ç•Œé‡Œï¼Œä»–ä»¬èƒ½å¤Ÿç›´æ¥è¯†åˆ«çš„åªæœ‰æœºå™¨è¯­è¨€ã€‚ç„¶è€Œï¼Œç”±äºæœºå™¨è¯­è¨€å¯¹äººç±»ä¸å¤Ÿå‹å¥½ï¼Œæ‰€ä»¥äººä»¬æ‰å‘æ˜äº†æ±‡ç¼–ï¼Œcï¼ŒJava...è®¸è®¸å¤šå¤šçš„äººç±»æ˜“è¯»çš„ç¼–ç¨‹è¯­è¨€ï¼Œæ‰€ä»¥æˆ‘ä¸ªäººå¯¹ç¼–ç¨‹è¯­è¨€çš„ç†è§£ä¸€ç›´æ˜¯å…¶å®ä»–ä»¬å°±æ˜¯æœºå™¨è¯­è¨€çš„è¯­æ³•ç³–ï¼Œè€Œç¼–ç¨‹è¯­è¨€çš„åˆ›é€ è¿‡ç¨‹ï¼Œå°±æ˜¯å®šä¹‰ä¸€ç§åˆç†çš„ï¼Œæ²¡æœ‰äºŒä¹‰æ€§çš„è¯­æ³•è§„åˆ™ï¼Œç„¶åå°±æ˜¯é€šè¿‡ç›´æ¥æˆ–é—´æ¥çš„æ–¹å¼å®ç°è¯¥è¯­æ³•åˆ°æœºå™¨è¯­è¨€çš„è½¬æ¢è¿‡ç¨‹ã€‚æ—¢ç„¶æ˜¯è¿™æ ·çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œè®¡ç®—æœºè¯­è¨€æ˜¯ä¸€ä¸ªè‡ªæˆ‘å®Œå–„çš„è¿‡ç¨‹ï¼šé¦–å…ˆæˆ‘ä»¬å®šäº†ä¸€ç§éå¸¸ç®€å•çš„x1(è¿™é‡Œåªæ˜¯ç”¨æ¥ä¸¾ä¾‹è¯´æ˜ï¼Œæœ‰æ²¡æœ‰xè¯­è¨€æœ‰å¾…è€ƒè¯)è¯­è¨€ï¼Œç„¶åç”¨æœºå™¨è¯­è¨€å®ç°äº†è¿™ä¸ªéå¸¸ç®€å•çš„x1è¯­è¨€çš„ç¼–è¯‘å™¨ï¼Œåˆ›é€ äº†x1è¯­è¨€ï¼Œå®ç°äº†éå¸¸ç®€å•çš„æ–°ç‰¹æ€§ï¼Œç„¶åæˆ‘ä»¬å†ç”¨x1è¯­è¨€(ç›¸å¯¹äºæœºå™¨è¯­è¨€è¾ƒé«˜çº§)å®ç°äº†å¦ä¸€äº›æ–°çš„ç‰¹æ€§çš„x2è¯­è¨€çš„ç¼–è¯‘å™¨ï¼Œåˆ›é€ äº†x2è¯­è¨€ï¼Œ...ï¼Œå¦‚æ­¤ä¸‹å»ï¼Œäººä»¬åˆ›é€ äº†æ±‡ç¼–è¯­è¨€ï¼Œä»è€Œåˆ›é€ äº†cè¯­è¨€ï¼Œæ¥ç€åˆ›é€ äº†ä¸–ç•Œä¸Šæœ€å¥½çš„è¯­è¨€PHP(ä¸çŸ¥é“æ˜¯ä¸æ˜¯çœŸçš„ï¼Œåæ­£å¤§å®¶éƒ½ä¹ æƒ¯è¿™ä¹ˆè¯´)ã€‚<br/>
åœ¨å„ç§é«˜çº§è¯­è¨€è¶Šæ¥è¶Šå¼ºå¤§çš„ä»Šå¤©ï¼Œæˆ‘ä»¬å¯èƒ½å¾ˆéš¾å†ä¼šå»æ¥è§¦æœ€åŸå§‹çš„ä¸œè¥¿ï¼Œé«˜åº¦å°è£…ç¡®å®æé«˜äº†ç”Ÿäº§åŠ›ï¼Œé™ä½äº†å­¦ä¹ æˆæœ¬ï¼Œä½†æ˜¯ä¹Ÿä½¿å¾—ç°ä»£ç¨‹åºå‘˜å°†å¤ªå¤šç²¾åŠ›èŠ±åœ¨äº†å„ç§è¯´æ˜ä¹¦ä¸Šï¼Œè€Œä¸æ¸…æ¥šå…¶æœ¬è´¨ã€‚<br/>
æ¯•ä¸šä¸€å¹´å¤šï¼Œå·¥ä½œäº†ä¸€å¹´å¤šï¼Œå¯¹äºè®¡ç®—æœºç¼–ç¨‹æœ‰äº†è‡ªå·±çš„çœ‹æ³•ï¼Œä¸å†åƒåœ¨å¤§å­¦çš„æ—¶å€™è®¤è¯†çš„é‚£æ ·è‚¤æµ…ï¼Œåè€Œè§‰å¾—å¤§å­¦ä¸­å­¦ä¹ çš„çŸ¥è¯†æ‰æ˜¯çœŸæ­£çš„å¹²è´§ï¼Œä¸ç¦æ„Ÿå¹æ›¾ç»æµªè´¹æ‰äº†å¤§å¥½å…‰é˜´ã€‚å¥½åœ¨é™¶æ¸Šæ˜æœ‰è¯äº‘ï¼šâ€œæ‚Ÿå·²å¾€ä¹‹ä¸è°ï¼ŒçŸ¥æ¥è€…ä¹‹å¯è¿½â€ã€‚<br/>
é—²æš‡ä¹‹ä½™ï¼Œæ‰’å¼€PHP(è¿™é‡Œä¹‹æ‰€ä»¥æ˜¯PHPå¹¶ä¸å› ä¸ºä»–æ˜¯ä¸–ç•Œä¸Šæœ€å¥½çš„è¯­è¨€ï¼Œåªæ˜¯å› ä¸ºæˆ‘ç›®å‰ä»äº‹çš„æ˜¯PHPå¼€å‘çš„å·¥ä½œè€Œå·²)æºç ï¼Œäº†è§£äº†å…¶å†…éƒ¨æ„é€ å’Œå®ç°åŸç†ï¼Œç™¾çœ‹ä¸ä¸€ç»ƒã€‚ä»Šå¤©å°±åˆæ­¥å­¦ä¹ yacc/lexäº†ï¼Œè®°å½•åœ¨æˆ‘çš„åšå®¢ä¸­ï¼Œä»¥ä¾¿ä»¥åç¿»é˜…å·©å›ºã€‚</p>

<h2 id="toc_1">è¿‡ç¨‹ç®€è¿°</h2>

<p>ä¸€èˆ¬æ¥è¯´ç¼–ç¨‹è¯­è¨€çš„è§£é‡Šæ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<p><strong>ONE</strong>. è¯æ³•åˆ†æ<br/>
å°†æºä»£ç æ‹†åˆ†æˆè‹¥å¹²Tokençš„è¿‡ç¨‹</p>

<p><strong>TWO</strong>.è¯­æ³•åˆ†æ<br/>
å°†Tokenæ„å»ºæˆSyntax Treeçš„è¿‡ç¨‹</p>

<p><strong>THREE</strong>.ç”Ÿæˆæ‰§è¡Œç <br/>
ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</p>

<h2 id="toc_2">yaccï¼ˆYet Another Compiler Compilerï¼‰</h2>

<p>ä¸‹é¢æ˜¯wikipediaä¸­å¯¹yaccçš„æè¿°</p>

<blockquote>
<p>Yacc is a computer program for the Unix operating system. It is a Look Ahead Left-to-Right (LALR) parser generator, generating a parser, the part of a compiler that tries to make syntactic sense of the source code, specifically a LALR parser, based on an analytic grammar written in a notation similar to Backusâ€“Naur Form (BNF). Yacc itself used to be available as the default parser generator on most Unix systems, though it has since been supplanted as the default by more recent, largely compatible, programs.</p>
</blockquote>

<p>å…¶å®‰è£…éå¸¸ç®€å•</p>

<pre><code class="language-bash">sudo apt-get install bison
</code></pre>

<h2 id="toc_3">lex/flex</h2>

<p>lex æ˜¯ä¸€ä¸ªç”Ÿæˆè¯æ³•åˆ†æå™¨çš„å·¥å…·ã€‚Lexè¯»è¿›ä¸€ä¸ªä»£è¡¨è¯æ³•åˆ†æå™¨è§„åˆ™çš„è¾“å…¥å­—ç¬¦ä¸²æµï¼Œç„¶åè¾“å‡ºä»¥Cè¯­è¨€å®åšçš„è¯æ³•åˆ†æå™¨æºä»£ç ã€‚ä¼ ç»Ÿä¸Šï¼Œlexå±äºå•†ä¸šè½¯ä»¶ï¼Œä½†æ˜¯æœ‰äº›æ ¹æ®åŸæœ¬AT&amp;Tä»£ç è¿™äº›ç‰ˆæœ¬çš„Lexå¯ä»¥ä»¥å…¬å¼€æºä»£ç çš„å½¢å¼è·å¾—ï¼Œå¹¶è¢«è§†ä¸ºæŸäº›ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œä¾‹å¦‚è¯´OpenSolariså’Œè´å°”å®éªŒå®¤ä¹å·é¡¹ç›®ã€‚å¦ä¸€ä¸ªæœ‰åçš„Lexå…¬å¼€æºä»£ç ç‰ˆæœ¬æ˜¯flexï¼Œä»£è¡¨&quot;å¿«é€Ÿçš„è¯æ³•åˆ†æå™¨&quot;ï¼ˆfast lexical analyzerï¼‰</p>

<p>åœ¨linuxä¸‹å®‰è£…</p>

<pre><code class="language-bash">sudo apt-get install flex
</code></pre>

<h2 id="toc_4">practice</h2>

<ul>
<li>å®ç°ä¸€ä¸ªç®€å•çš„è®¡ç®—ç¨‹åº</li>
</ul>

<p>é¦–å…ˆå®šä¹‰lexè§„åˆ™ï¼Œå…¶æ‰©å±•åä¸º<code>.l</code>ï¼Œåœ¨lexä¸­å¯ä»¥å¾ˆå®¹æ˜“è¯»æ‡‚å…¶å®šä¹‰çš„è§„åˆ™ï¼Œå› ä¸ºä»–ç”¨åˆ°çš„æ˜¯æ­£åˆ™è¡¨è¾¾å¼ã€‚</p>

<pre><code class="language-c">%{
/*
 |------------------------------------------------------------------
 | linger test
 |------------------------------------------------------------------
 | @author    : liubang
 | @date      : 16/10/27 ä¸‹åˆ8:28
 | @copyright : (c) iliubang.cn
 | @license   : MIT (http://opensource.org/licenses/MIT)
 |------------------------------------------------------------------
 */

#include &lt;stdio.h&gt;
#include &quot;y.tab.h&quot;

int yywrap(void)
{
    return 1;
}
%}

%%

&quot;+&quot;     return ADD;
&quot;-&quot;     return SUB;
&quot;*&quot;     return MUL;
&quot;/&quot;     return DIV;
&quot;\n&quot;        return CR;

([1-9][0-9]*)|0|([0-9]+\.[0-9]+) {
    double d;
    sscanf(yytext, &quot;%lf&quot;, &amp;d);
    yylval.double_value = d;
    return DOUBLE_LITERAL;
}

[ \t] ;
. {
    fprintf(stderr, &quot;lexical error.\n&quot;);
    exit(1);
}
%%

</code></pre>

<p>å¯ä»¥çœ‹åˆ°ä»¥ä¸Šçš„ä»£ç ä¸»è¦åŒ…å«ä¸¤éƒ¨åˆ†ï¼Œ<code>%{</code> <code>%}</code>åŒ…å«çš„éƒ¨åˆ†å’Œ<code>%%</code> <code>%%</code>åŒ…å«çš„éƒ¨åˆ†ã€‚å‰ä¸€éƒ¨åˆ†å«<strong>å®šä¹‰åŒºå—</strong>, åè€…æ˜¯<strong>è§„åˆ™åŒºå—</strong>ï¼Œå®šä¹‰åŒºå—å†…çš„ä»£ç å°†ä¼šè¢«åŸæ ·è¾“å‡ºï¼Œåœ¨å®šä¹‰åŒºå—ä¸­<code>#include &quot;y.tab.h&quot;</code>å°†ä¼šåœ¨yaccç¼–è¯‘å…¶è§„åˆ™æ–‡ä»¶åè‡ªåŠ¨ç”Ÿæˆï¼Œ<code>ADD</code> <code>SUB</code> <code>MUL</code> <code>DIV</code> <code>CR</code> <code>DOUBLE_LITERAL</code>ç­‰éƒ½æ˜¯åœ¨y.tab.hä¸­å®šä¹‰çš„macroã€‚<br/>
åœ¨å®šä¹‰åŒºå—ä¸­ï¼Œæœ‰ä¸€ä¸ªåä¸º<code>yywrap</code>çš„functionï¼Œå…¶ä½œç”¨æ˜¯è‡ªåŠ¨link lexçš„åº“æ–‡ä»¶ã€‚<br/>
è‡³äºè§„åˆ™åŒºå—ï¼Œå­¦è¿‡æ­£åˆ™è¡¨è¾¾å¼çš„äººä¸€çœ‹å°±ä¼šæ˜ç™½ï¼Œå…¶ä½œç”¨å°±æ˜¯ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æè¿°Tokenã€‚è§„åˆ™åŒºå—çš„å®šä¹‰ä¸ºï¼šæ­£åˆ™è¡¨è¾¾å¼ï¼Œåè¾¹è·Ÿä¸ŠCä»£ç ï¼Œè¿™äº›ä»£ç ç”¨<code>{}</code>æ‹¬èµ·æ¥ï¼Œè¯»å…¥çš„å­—ç¬¦æµæ»¡è¶³äº†æ­£åˆ™ï¼Œåˆ™æ‰§è¡Œå…¶åçš„ä»£ç ï¼ŒåŒ¹é…åˆ°çš„åŸå­—ç¬¦è¢«ä¿å­˜åœ¨<code>yytext</code>è¿™ä¸ªå…¨å±€å˜é‡ä¸­ã€‚</p>

<p>æ¥ç€æ¥ç¼–å†™yaccçš„è§„åˆ™ï¼Œå…¶æ‰©å±•åä¸º<code>.y</code>ã€‚</p>

<pre><code class="language-c">%{
/*
 |------------------------------------------------------------------
 | linger test
 |------------------------------------------------------------------
 | @author    : liubang
 | @date      : 16/10/27 ä¸‹åˆ8:43
 | @copyright : (c) iliubang.cn
 | @license   : MIT (http://opensource.org/licenses/MIT)
 |------------------------------------------------------------------
 */

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#define YYDEBUG 1

%}

%union {
    int int_value;
    double  double_value;
}

%token &lt;double_value&gt;       DOUBLE_LITERAL
%token ADD SUB MUL DIV CR
%type &lt;double_value&gt; expression term primary_expression

%%

line_list
    : line
    | line_list line
;
line
    : expression CR
    {
        printf(&quot;&gt;&gt;%lf\n&quot;, $1);
    }
;
expression
    : term
    | expression ADD term
    {
        $$ = $1 + $3;
    }
    | expression SUB term
    {
        $$ = $1 - $3;
    }
;
term
    : primary_expression
    | term MUL primary_expression
    {
        $$ = $1 * $3;
    }
    | term DIV primary_expression
    {
        $$ = $1 / $3;
    }
;
primary_expression
    : DOUBLE_LITERAL
;

%%

int yyerror(char const *str)
{
    extern char *yytext;
    fprintf(stderr, &quot;syntax error near %s\n&quot;, yytext);
    return 0;
}

int main(void)
{
    extern int yyparse(void);
    extern FILE *yyin;

    yyin = stdin;
    if (yyparse()) {
        fprintf(stderr, &quot;Core Dump!\n&quot;);
        exit(1);
    }
}
</code></pre>

<p>yaccè§„åˆ™å®šä¹‰è·Ÿlexç›¸ä¼¼ï¼Œéƒ½ç”¨åˆ°äº†<code>%{%}</code> <code>%%</code>æ¥åŒ…å«ä»£ç å—ã€‚<br/>
åŒæ ·çš„æ˜¯<code>%{%}</code>åŒ…è£¹çš„ä»£ç å°†è¢«åŸæ ·è¾“å‡ºã€‚<br/>
åœ¨<code>%union</code>å®šä¹‰ä¸­ï¼Œå£°æ˜äº†è®°å·å’Œéç»ˆç»“ç¬¦çš„ç±»å‹ï¼Œå…¶æœ€ç»ˆä¼šè¢«ç¼–è¯‘æˆä¸€ä¸ªcè¯­è¨€çš„unionã€‚è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªint ç±»å‹çš„int_value å’Œ doubleç±»å‹çš„double_valueã€‚<br/>
<code>%token</code>å¼€å¤´çš„è¡Œæ˜¯Tokençš„å£°æ˜ï¼Œæ‰€æœ‰ç”¨åˆ°çš„Tokenç±»å‹éƒ½åœ¨è¿™é‡Œå®šä¹‰ã€‚å¯¹äº<code>ADD</code> <code>SUB</code> <code>MUL</code> <code>DIV</code> <code>CR</code>ç­‰è®°å·åªéœ€è¦åŒ…å«å…¶ç±»å‹å³å¯ï¼Œè€Œå¯¹äºå€¼ä¸º<code>DOUBLE_LITERAL</code>çš„Tokenï¼Œå…¶ç±»å‹è¢«æŒ‡å®šä¸º<code>&lt;double_value&gt;</code>ï¼Œè¿™é‡Œçš„double_valueæ­£æ˜¯æ¥è‡ªäºå‰é¢å£°æ˜çš„unionä¸­çš„æˆå‘˜ä¹‹ä¸€ã€‚<br/>
<code>%%</code>åŒ…è£¹çš„éƒ¨åˆ†å«åšè§„åˆ™åŒºå—ï¼Œç”±è¯­æ³•è§„åˆ™å’ŒCè¯­è¨€ç¼–å†™çš„ç›¸åº”çš„è¡Œä¸ºä¸¤éƒ¨åˆ†æ„æˆã€‚åœ¨yaccä¸­ä½¿ç”¨äº†ç±»ä¼¼äºBNFèŒƒå¼æ¥ç¼–å†™è¯­æ³•è§„åˆ™ã€‚ç”±äºä½¿ç”¨äº†è‡ªç„¶è¯­è¨€ä½œä¸ºæ ‡è®°ï¼Œç†è§£ä¸Šè¿˜æ˜¯å¾ˆå®¹æ˜“çš„ã€‚ä¸‹é¢ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>

<pre><code class="language-c">line_list                 /* å¤šè¡Œè§„åˆ™ */
    : line                  /* å•è¡Œ */
    | line_list line        /* æˆ–è€…å¤šè¡Œåè·Ÿå•è¡Œ */
;
line                       /* å•è¡Œ */
    : expression CR          /* è¡¨è¾¾å¼åè·Ÿæ¢è¡Œç¬¦ */
;
expression                 /* è¡¨è¾¾å¼ */
    : term                   /* å’Œé¡¹ */
    | expression ADD term    /* æˆ–è€…è¡¨è¾¾å¼åŠ ä¸Šå’Œé¡¹ */
    {                        /* åŒ¹é…åæ‰§è¡Œçš„action */
        $$ = $1 + $3;
    }
    | expression SUB term    /* æˆ–è€…è¡¨è¾¾å¼å‡å»å’Œé¡¹ */
    {                        /* åŒ¹é…åæ‰§è¡Œçš„action */
        $$ = $1 - $3;
    }
;
term                        /* å’Œé¡¹ */
    : primary_expression      /* ä¸€å…ƒè¡¨è¾¾å¼ */
    | term MUL primary_expression /* æˆ–è€…å’Œé¡¹ä¹˜ä»¥ä¸€å…ƒè¡¨è¾¾å¼ */
    {                          /* åŒ¹é…åæ‰§è¡Œçš„action */
        $$ = $1 * $3;
    }                          
    | term DIV primary_expression /* æˆ–è€…å’Œé¡¹é™¤ä»¥ä¸€å…ƒè¡¨è¾¾å¼ */
    {                             /* åŒ¹é…åæ‰§è¡Œçš„action */
        $$ = $1 / $3;
    }
;
primary_expression          /* ä¸€å…ƒè¡¨è¾¾å¼ */
    : DOUBLE_LITERAL          /* å®æ•°å­—é¢é‡ */
;
</code></pre>

<p>å†™å¥½äº†è§„åˆ™ï¼Œé‚£ä¹ˆå°±æ¥ç¼–è¯‘è¿è¡Œ</p>

<pre><code class="language-bash">yacc -dv foo.y
flex foo.l
gcc -std=c99 -Wall -g -o foo y.tab.c lex.yy.c
</code></pre>

<p>è¿™æ ·å°±ç”Ÿæˆäº†<code>foo</code>è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶<br/>
è¿è¡Œfoo</p>

<pre><code class="language-bash">liubang@venux:~/workspace/c/my_lang/lex$ make run
1 + 3
&gt;&gt;4.000000
1/2 
&gt;&gt;0.500000
4 * 5
&gt;&gt;20.000000
</code></pre>

<p>å½“ç„¶æˆ‘ä¸ªäººåœ¨å¼€å‘cç¨‹åºçš„æ—¶å€™åå‘äºä½¿ç”¨makeå·¥å…·æ¥ç¼–è¯‘ä»£ç ï¼Œè¿™æ ·ä¼šå¾ˆæ–¹ä¾¿ã€‚ä¸‹é¢æ˜¯æˆ‘çš„Makefileæ–‡ä»¶:</p>

<pre><code class="language-makefile">CFLAGS = -O2 -g -Wall -std=c99
EXEC = foo
OBJS =  y.tab.o \
    lex.yy.o


%.c:
    yacc -dv foo.y
    lex foo.l

%.o: %.c
     $(CC) $(CFLAGS) -o $@ -c $&lt;

$(EXEC): $(OBJS)
    $(CC) $(OBJS) -o $@

all: $(EXEC)

run: $(EXEC)
    @./$(EXEC)

clean:
    $(RM) $(OBJS) $(EXEC)
</code></pre>

<p>åªéœ€è¦æ‰§è¡Œ<code>make run</code>å‘½ä»¤å³å¯è¿è¡Œï¼</p>

<h2 id="toc_5">é™„åŠ </h2>

<p>å¯èƒ½æœ‰äººä¼šç–‘æƒ‘ï¼Œè¿™ç©æ„å­¦ç€æœ‰ä»€ä¹ˆç”¨ï¼Œé‚£ä¹ˆæœ‰å…´è¶£çš„ä½ å¯ä»¥ä¸‹è½½ä¸€ä»½PHPçš„æºä»£ç ï¼Œåœ¨Zend(Zendå¼•æ“æ ¸å¿ƒæ–‡ä»¶)ç›®å½•ä¸­ä½ ä¸éš¾æ‰¾åˆ°<code>zend_language_scanner.l</code>,<code>zend_ini_scanner.l</code>,<code>zend_ini_parser.y</code>,<code>zend_language_parser.y</code>è¿™å‡ ä¸ªæ–‡ä»¶ï¼Œæ‰“å¼€å…¶å†…å®¹ï¼Œæ˜¯ä¸æ˜¯ä¸å†é‚£ä¹ˆææƒ§å’Œé™Œç”Ÿäº†å‘¢ã€‚</p>

<h2 id="toc_6">Summary</h2>

<p>æœ¬æ–‡åªæ˜¯åˆæ­¥ä»‹ç»yacc/lexå·¥å…·ç”Ÿæˆè¯æ³•è§£æå™¨å’Œè¯­æ³•è§£æå™¨çš„æœ€åŸºæœ¬ç”¨æ³•ï¼Œæ²¡æœ‰å¤ªå¤šçš„é˜è¿°è¯æ³•è§£æçš„åŸç†å’Œè¿‡ç¨‹ï¼Œæ‰€ä»¥æ›´åå®è·µï¼Œå†ç”±äºæœ¬äººæ¯•ä¸šä¸€å¹´å¤šå®åœ¨å¾ˆä¹…æ²¡å†™æ–‡ç« äº†ï¼Œå¸¸å¸¸ä¼šæç¬”ä¸çŸ¥ä»ä½•è¯´èµ·ï¼Œæ‰€ä»¥å†™èµ·æ¥å¾ˆæ…¢ï¼ŒåŠ ä¹‹ç™½å¤©è¦å·¥ä½œï¼Œæ—¶é—´è¾ƒç´§ï¼Œæ‰€ä»¥ä»Šå¤©å°±åˆ°è¿™é‡Œäº†ï¼Œè‡³äºç†è®ºçš„é˜è¿°ï¼Œéœ€è¦æ—¶é—´æ¥æ…¢æ…¢é…é…¿ğŸ˜‚ï¼</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[An Introduction to Lock-Free Programming]]></title>
    <link href="http://iliubang.github.io/14771244487868.html"/>
    <updated>2016-10-22T16:20:48+08:00</updated>
    <id>http://iliubang.github.io/14771244487868.html</id>
    <content type="html"><![CDATA[
<p><strong>[<a href="http://preshing.com/20120612/an-introduction-to-lock-free-programming/">Reference</a>]</strong></p>

<p>Lock-free programming is a challenge, not just because of the complexity of the task itself, but because of how difficult it can be to penetrate the subject in the first place.</p>

<p>I was fortunate in that my first introduction to lock-free (also known as lockless) programming was Bruce Dawsonâ€™s excellent and comprehensive white paper, Lockless Programming Considerations. And like many, Iâ€™ve had the occasion to put Bruceâ€™s advice into practice developing and debugging lock-free code on platforms such as the Xbox 360.</p>

<p>Since then, a lot of good material has been written, ranging from abstract theory and proofs of correctness to practical examples and hardware details. Iâ€™ll leave a list of references in the footnotes. At times, the information in one source may appear orthogonal to other sources: For instance, some material assumes sequential consistency, and thus sidesteps the memory ordering issues which typically plague lock-free C/C++ code. The new C++11 atomic library standard throws another wrench into the works, challenging the way many of us express lock-free algorithms.</p>

<p>In this post, Iâ€™d like to re-introduce lock-free programming, first by defining it, then by distilling most of the information down to a few key concepts. Iâ€™ll show how those concepts relate to one another using flowcharts, then weâ€™ll dip our toes into the details a little bit. At a minimum, any programmer who dives into lock-free programming should already understand how to write correct multithreaded code using mutexes, and other high-level synchronization objects such as semaphores and events.</p>

<h2 id="toc_0">What Is It?</h2>

<p>People often describe lock-free programming as programming without mutexes, which are also referred to as locks. Thatâ€™s true, but itâ€™s only part of the story. The generally accepted definition, based on academic literature, is a bit more broad. At its essence, lock-free is a property used to describe some code, without saying too much about how that code was actually written.</p>

<p>Basically, if some part of your program satisfies the following conditions, then that part can rightfully be considered lock-free. Conversely, if a given part of your code doesnâ€™t satisfy these conditions, then that part is not lock-free.<br/>
<img src="media/14771244487868/its-lock-free.png" alt="its-lock-free"/></p>

<p>In this sense, the lock in lock-free does not refer directly to mutexes, but rather to the possibility of â€œlocking upâ€ the entire application in some way, whether itâ€™s deadlock, livelock â€“ or even due to hypothetical thread scheduling decisions made by your worst enemy. That last point sounds funny, but itâ€™s key. Shared mutexes are ruled out trivially, because as soon as one thread obtains the mutex, your worst enemy could simply never schedule that thread again. Of course, real operating systems donâ€™t work that way â€“ weâ€™re merely defining terms.</p>

<p>Hereâ€™s a simple example of an operation which contains no mutexes, but is still not lock-free. Initially, X = 0. As an exercise for the reader, consider how two threads could be scheduled in a way such that neither thread exits the loop.</p>

<pre><code class="language-c">while (X == 0)
{
    X = 1 - X;
}
</code></pre>

<p>Nobody expects a large application to be entirely lock-free. Typically, we identify a specific set of lock-free operations out of the whole codebase. For example, in a lock-free queue, there might be a handful of lock-free operations such as <code>push</code>, <code>pop</code>, perhaps <code>isEmpty</code>, and so on.</p>

<p>Herlihy &amp; Shavit, authors of The Art of Multiprocessor Programming, tend to express such operations as class methods, and offer the following succinct definition of lock-free (see slide 150): â€œIn an infinite execution, infinitely often some method call finishes.â€ In other words, as long as the program is able to keep calling those lock-free operations, the number of completed calls keeps increasing, no matter what. It is algorithmically impossible for the system to lock up during those operations.</p>

<p>One important consequence of lock-free programming is that if you suspend a single thread, it will never prevent other threads from making progress, as a group, through their own lock-free operations. This hints at the value of lock-free programming when writing interrupt handlers and real-time systems, where certain tasks must complete within a certain time limit, no matter what state the rest of the program is in.</p>

<p>A final precision: Operations that are designed to block do not disqualify the algorithm. For example, a queueâ€™s pop operation may intentionally block when the queue is empty. The remaining codepaths can still be considered lock-free.</p>

<h2 id="toc_1">Lock-Free Programming Techniques</h2>

<p>It turns out that when you attempt to satisfy the non-blocking condition of lock-free programming, a whole family of techniques fall out: atomic operations, memory barriers, avoiding the ABA problem, to name a few. This is where things quickly become diabolical.</p>

<p>So how do these techniques relate to one another? To illustrate, Iâ€™ve put together the following flowchart. Iâ€™ll elaborate on each one below.<br/>
<img src="media/14771244487868/techniques.png" alt="techniques"/></p>

<h2 id="toc_2">Atomic Read-Modify-Write Operations</h2>

<p>Atomic operations are ones which manipulate memory in a way that appears indivisible: No thread can observe the operation half-complete. On modern processors, lots of operations are already atomic. For example, aligned reads and writes of simple types are usually atomic.</p>

<p>Read-modify-write (RMW) operations go a step further, allowing you to perform more complex transactions atomically. Theyâ€™re especially useful when a lock-free algorithm must support multiple writers, because when multiple threads attempt an RMW on the same address, theyâ€™ll effectively line up in a row and execute those operations one-at-a-time. Iâ€™ve already touched upon RMW operations in this blog, such as when implementing a lightweight mutex, a recursive mutex and a lightweight logging system.</p>

<p>Examples of RMW operations include <code>_InterlockedIncrement</code> on Win32, <code>OSAtomicAdd32</code> on iOS, and <code>std::atomic&lt;int&gt;::fetch_add</code> in C++11. Be aware that the C++11 atomic standard does not guarantee that the implementation will be lock-free on every platform, so itâ€™s best to know the capabilities of your platform and toolchain. You can call <code>std::atomic&lt;&gt;::is_lock_free</code> to make sure.</p>

<p>Different CPU families support RMW in different ways. Processors such as PowerPC and ARM expose load-link/store-conditional instructions, which effectively allow you to implement your own RMW primitive at a low level, though this is not often done. The common RMW operations are usually sufficient.</p>

<p>As illustrated by the flowchart, atomic RMWs are a necessary part of lock-free programming even on single-processor systems. Without atomicity, a thread could be interrupted halfway through the transaction, possibly leading to an inconsistent state.</p>

<h2 id="toc_3">Compare-And-Swap Loops</h2>

<p>Perhaps the most often-discussed RMW operation is compare-and-swap (CAS). On Win32, CAS is provided via a family of intrinsics such as <code>_InterlockedCompareExchange</code>. Often, programmers perform compare-and-swap in a loop to repeatedly attempt a transaction. This pattern typically involves copying a shared variable to a local variable, performing some speculative work, and attempting to publish the changes using CAS:</p>

<pre><code class="language-c">void LockFreeQueue::push(Node* newHead)
{
    for (;;)
    {
        // Copy a shared variable (m_Head) to a local.
        Node* oldHead = m_Head;

        // Do some speculative work, not yet visible to other threads.
        newHead-&gt;next = oldHead;

        // Next, attempt to publish our changes to the shared variable.
        // If the shared variable hasn&#39;t changed, the CAS succeeds and we return.
        // Otherwise, repeat.
        if (_InterlockedCompareExchange(&amp;m_Head, newHead, oldHead) == oldHead)
            return;
    }
}
</code></pre>

<p>Such loops still qualify as lock-free, because if the test fails for one thread, it means it must have succeeded for another â€“ though some architectures offer a weaker variant of CAS where thatâ€™s not necessarily true. Whenever implementing a CAS loop, special care must be taken to avoid the ABA problem.</p>

<h2 id="toc_4">Sequential Consistency</h2>

<p>Sequential consistency means that all threads agree on the order in which memory operations occurred, and that order is consistent with the order of operations in the program source code. Under sequential consistency, itâ€™s impossible to experience memory reordering shenanigans like the one I demonstrated in a previous post.</p>

<p>A simple (but obviously impractical) way to achieve sequential consistency is to disable compiler optimizations and force all your threads to run on a single processor. A processor never sees its own memory effects out of order, even when threads are pre-empted and scheduled at arbitrary times.</p>

<p>Some programming languages offer sequentially consistency even for optimized code running in a multiprocessor environment. In C++11, you can declare all shared variables as C++11 atomic types with default memory ordering constraints. In Java, you can mark all shared variables as volatile. Hereâ€™s the example from my previous post, rewritten in C++11 style:</p>

<pre><code class="language-c++">std::atomic&lt;int&gt; X(0), Y(0);
int r1, r2;

void thread1()
{
    X.store(1);
    r1 = Y.load();
}

void thread2()
{
    Y.store(1);
    r2 = X.load();
}
</code></pre>

<p>Because the C++11 atomic types guarantee sequential consistency, the outcome r1 = r2 = 0 is impossible. To achieve this, the compiler outputs additional instructions behind the scenes â€“ typically memory fences and/or RMW operations. Those additional instructions may make the implementation less efficient compared to one where the programmer has dealt with memory ordering directly.</p>

<h2 id="toc_5">Memory Ordering</h2>

<p>As the flowchart suggests, any time you do lock-free programming for multicore (or any symmetric multiprocessor), and your environment does not guarantee sequential consistency, you must consider how to prevent memory reordering.</p>

<p>On todayâ€™s architectures, the tools to enforce correct memory ordering generally fall into three categories, which prevent both compiler reordering and processor reordering:</p>

<ul>
<li>A lightweight sync or fence instruction, which Iâ€™ll talk about in future posts;</li>
<li>A full memory fence instruction, which Iâ€™ve demonstrated previously;</li>
<li>Memory operations which provide acquire or release semantics.</li>
</ul>

<p>Acquire semantics prevent memory reordering of operations which follow it in program order, and release semantics prevent memory reordering of operations preceding it. These semantics are particularly suitable in cases when thereâ€™s a producer/consumer relationship, where one thread publishes some information and the other reads it. Iâ€™ll also talk about this more in a future post.</p>

<h2 id="toc_6">Different Processors Have Different Memory Models</h2>

<p>Different CPU families have different habits when it comes to memory reordering. The rules are documented by each CPU vendor and followed strictly by the hardware. For instance, PowerPC and ARM processors can change the order of memory stores relative to the instructions themselves, but normally, the x86/64 family of processors from Intel and AMD do not. We say the former processors have a more relaxed memory model.</p>

<p>Thereâ€™s a temptation to abstract away such platform-specific details, especially with C++11 offering us a standard way to write portable lock-free code. But currently, I think most lock-free programmers have at least some appreciation of platform differences. If thereâ€™s one key difference to remember, itâ€™s that at the x86/64 instruction level, every load from memory comes with acquire semantics, and every store to memory provides release semantics â€“ at least for non-SSE instructions and non-write-combined memory. As a result, itâ€™s been common in the past to write lock-free code which works on x86/64, but fails on other processors.</p>

<p>If youâ€™re interested in the hardware details of how and why processors perform memory reordering, Iâ€™d recommend Appendix C of Is Parallel Programming Hard. In any case, keep in mind that memory reordering can also occur due to compiler reordering of instructions.</p>

<p>In this post, I havenâ€™t said much about the practical side of lock-free programming, such as: When do we do it? How much do we really need? I also havenâ€™t mentioned the importance of validating your lock-free algorithms. Nonetheless, I hope for some readers, this introduction has provided a basic familiarity with lock-free concepts, so you can proceed into the additional reading without feeling too bewildered. As usual, if you spot any inaccuracies, let me know in the comments.</p>

]]></content>
  </entry>
  
</feed>
